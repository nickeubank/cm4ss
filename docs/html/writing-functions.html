
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Writing Functions &#8212; CM4SS  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Loops" href="controlflow.html" />
    <link rel="prev" title="Wide &amp; Long Data" href="wide-and-long.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Writing-Functions">
<h1>Writing Functions<a class="headerlink" href="#Writing-Functions" title="Permalink to this headline">¶</a></h1>
<p>This tutorial explains how you can write your own functions in R. Why do this? Functions are useful when you want to execute a task over and over again, resulting in less verbose and more easily interpretable code. After explaining the basics of writing functions, this tutorial covers two data science applications for writing functions.</p>
<section id="Motivation">
<h2>Motivation<a class="headerlink" href="#Motivation" title="Permalink to this headline">¶</a></h2>
<p>To illustrate the value of functions, let’s start by a thought experiment: say R didn’t provide a function for finding the median of a numeric vector. (Of course this is not true — R has a built-in function called <code class="docutils literal notranslate"><span class="pre">median()</span></code> for this purpose.) In this annoying scenario, it would still be possible to find the median using a few lines of code.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create a numeric vector</span>
<span class="n">v</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>

<span class="c1"># Find the number of elements in v</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="c1"># Is n odd?</span>
<span class="n">n</span> <span class="o">%%</span> <span class="m">2</span>  <span class="c1">#use mod to find remainder after dividing by 2; if remainder is 1 --&gt; odd</span>

<span class="c1"># Cool, it&#39;s odd so let&#39;s find the mid-value after sorting v</span>
<span class="n">v_sort</span> <span class="o">&lt;-</span> <span class="nf">sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="n">v_sort</span><span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="m">2</span> <span class="o">+</span> <span class="m">1</span><span class="p">]</span> <span class="c1">#this is the median</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
1</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
5</div>
</div>
<p>Ok, we found the median, but what a nightmare! Imagine if we had to go through these steps every time we wanted to find the median. Plus, the code above isn’t general enough to account for scenarios in which the numeric vector has an even number of elements. In scenarios like this, it’s therefore extremely useful to write a function. Here’s one way of doing so for finding the median:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">median2</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">odd</span> <span class="o">&lt;-</span> <span class="n">n</span> <span class="o">%%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span>
    <span class="n">vec_sort</span> <span class="o">&lt;-</span> <span class="nf">sort</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="nf">if</span><span class="p">(</span><span class="n">odd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">&lt;-</span> <span class="n">vec_sort</span><span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="m">2</span> <span class="o">+</span> <span class="m">1</span><span class="p">]</span>
    <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">vec_sort</span><span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="m">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">vec_sort</span><span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="m">2</span> <span class="o">+</span> <span class="m">1</span><span class="p">])</span> <span class="o">/</span> <span class="m">2</span>
    <span class="p">}</span>

    <span class="nf">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Let’s test if it works on two vectors, one with an odd number of elements and the other with an even number:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">v1</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
<span class="nf">median2</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>

<span class="n">v2</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">12</span><span class="p">)</span>
<span class="nf">median2</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
5</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
6.5</div>
</div>
<p>This motivating example shows that writing functions can save us many lines of code and avoid mistakes that inevitably will happen if you rely too heavily on copying and pasting code.</p>
</section>
<section id="Building-blocks">
<h2>Building blocks<a class="headerlink" href="#Building-blocks" title="Permalink to this headline">¶</a></h2>
<p>Remind yourself of a basic mathematical principle: a function takes some input, transforms it, and outputs the transformation. For example, the function <em>f(x) = 2x</em> takes a vector <em>x</em> and transforms each element to twice its original value. Functions in R (and other languages) do the same thing. For example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">doubleval</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="m">2</span> <span class="o">*</span> <span class="n">x</span> <span class="c1">#write a function that doubles x</span>
<span class="nf">doubleval</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">7</span><span class="p">))</span> <span class="c1">#test the function on a vector</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>6</li><li>10</li><li>14</li></ol></div>
</div>
<p>Here are other, equivalent, ways of writing this function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">doubleval</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">return</span><span class="p">(</span><span class="m">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="n">doubleval</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tranformation</span> <span class="o">&lt;-</span> <span class="m">2</span> <span class="o">*</span> <span class="n">x</span>
    <span class="n">transformation</span>
<span class="p">}</span>
<span class="n">doubleval</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tranformation</span> <span class="o">&lt;-</span> <span class="m">2</span> <span class="o">*</span> <span class="n">x</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">transformation</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Observe the following:</p>
<ol class="arabic simple">
<li><p>Functions include some input or, more technically, one or many <em>parameters</em>. The function <code class="docutils literal notranslate"><span class="pre">doubleval</span></code> has one parameter called <code class="docutils literal notranslate"><span class="pre">x</span></code>; <code class="docutils literal notranslate"><span class="pre">median2</span></code> also has one parameter (<code class="docutils literal notranslate"><span class="pre">vec</span></code>). The name of parameters are arbitrary: you can call them whatever you want as long as you reference the same name within the function. Note that functions often have more than one parameter.</p></li>
<li><p>Functions include a line that specifies the output of the function. For clarity, it is useful to use the <code class="docutils literal notranslate"><span class="pre">return()</span></code> statement for indicating what the function is outputting, although this is not necessary.</p></li>
<li><p>If a function includes several operations, those operations should be written on separate lines and be surrounded by curly brackets (<code class="docutils literal notranslate"><span class="pre">{}</span></code>). Very simple functions can be written on one line, omitting the curly brackets.</p></li>
<li><p>Objects created within functions do not exist in the global variable space. For example, <code class="docutils literal notranslate"><span class="pre">vec_sort</span></code> in the function <code class="docutils literal notranslate"><span class="pre">median2</span></code> (and other objects created within the function) cannot be accessed outside the function. This relates to an important feature of programming called <a class="reference external" href="http://www.wikiwand.com/en/Scope_(computer_science)">scope</a>.</p></li>
</ol>
</section>
<section id="Applications">
<h2>Applications<a class="headerlink" href="#Applications" title="Permalink to this headline">¶</a></h2>
<p>Functions can be used in a wide variety of scenarios. Here are two applications, which I go over in detail below:</p>
<ol class="arabic simple">
<li><p>A function that reads and manipulates a .csv file. Use it with <code class="docutils literal notranslate"><span class="pre">lapply()</span></code> or in a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop to iterate over several files with a similar structure. Then combine the resulting data frames into one data frame.</p></li>
<li><p>A function that carries out a regression or graphing analysis on a select number of variables or on a subset of the data.</p></li>
</ol>
</section>
<section id="Reading-several-files">
<h2>Reading several files<a class="headerlink" href="#Reading-several-files" title="Permalink to this headline">¶</a></h2>
<p>Begin by downloading a <a class="reference external" href="../data/nyc-311-sample.zip">.zip file with service request data from NYC</a>. The zip file contains six files for years 2004-2009, each with 10,000 observations. The data are originally from <a class="reference external" href="https://nycopendata.socrata.com/data?cat=social%20services">NYC’s Open Data portal</a>, which hosts datasets with millions of service requests filed by residents through the city’s 311 program. For the purpose of this example, I have taken a random sample of 10,000 for each year.</p>
<p>Here’s what the 2004 file looks like (the other years have the same structure).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>

<span></span><span class="n">``</span>`<span class="p">{</span><span class="n">r</span><span class="p">,</span> <span class="n">eval</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">}</span>
<span class="c1"># Read the 311 data for 2004 (after setting the working directory)</span>
<span class="n">nyc04</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;nyc-311-2004-sample.csv&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Error in parse(text = x, srcfile = src): attempt to use zero-length variable name
Traceback:

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc04</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/nyc-311-sample/nyc-311-2004-sample.csv&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The variables in the data are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Unique.Key</span></code>: An id number unique to each request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Created.Date</span></code>: The date the request was filed in the 311 system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Closed.Date</span></code>: The date the request was resolved by city workers (<code class="docutils literal notranslate"><span class="pre">NA</span></code> implies that it was never resolved).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Complaint.Type</span></code>: The subject of the complaint.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Location</span></code>: Coordinates that give the location of the service issue.</p></li>
</ul>
<p>Our goal with the function is to read the file and clean it. In particular, we want to convert the <code class="docutils literal notranslate"><span class="pre">Created.Date</span></code> and <code class="docutils literal notranslate"><span class="pre">Closed.Date</span></code> variables so that R recognizes them as dates. From these variables, we can then calculate measures of <em>government responsiveness</em>: (1) how many days it took city workers to resolve a request, and (2) whether or not a request was resolved within a week.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Load required packages</span>
<span class="nf">require</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">require</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span> <span class="c1">#to work with dates</span>

<span class="c1"># Create a function that reads and cleans a service request file.</span>
<span class="c1"># The input is the name of a service request file and the</span>
<span class="c1"># output is a data frame with cleaned variables.</span>
<span class="n">clean_dta</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1"># Read the file and save it to an object called &#39;dta&#39;</span>
    <span class="n">dta</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># Clean the dates in the dta file and generate responsiveness measures</span>
    <span class="n">dta</span> <span class="o">&lt;-</span> <span class="n">dta</span> <span class="o">%&gt;%</span>
        <span class="nf">mutate</span><span class="p">(</span><span class="n">opened</span> <span class="o">=</span> <span class="nf">mdy</span><span class="p">(</span><span class="nf">substring</span><span class="p">(</span><span class="n">Created.Date</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)),</span>
               <span class="n">closed</span> <span class="o">=</span> <span class="nf">mdy</span><span class="p">(</span><span class="nf">substring</span><span class="p">(</span><span class="n">Closed.Date</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)),</span>
               <span class="n">resptime</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">difftime</span><span class="p">(</span><span class="n">closed</span><span class="p">,</span> <span class="n">opened</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="s">&quot;days&quot;</span><span class="p">)),</span>
               <span class="n">resptime</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">resptime</span> <span class="o">&gt;=</span><span class="m">0</span><span class="p">,</span> <span class="n">resptime</span><span class="p">,</span> <span class="kc">NA</span><span class="p">),</span>
               <span class="n">solvedin7</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">resptime</span> <span class="o">&lt;=</span> <span class="m">7</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>

    <span class="c1"># Return the cleaned data</span>
    <span class="nf">return</span><span class="p">(</span><span class="n">dta</span><span class="p">)</span>
<span class="p">}</span>

</pre></div>
</div>
</div>
<p>Let’s test the function on the 2004 data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Execute function on the 2004 data</span>
<span class="n">nyc04</span> <span class="o">&lt;-</span> <span class="nf">clean_dta</span><span class="p">(</span><span class="s">&quot;nyc-311-2004-sample.csv&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc04</span> <span class="o">&lt;-</span> <span class="nf">clean_dta</span><span class="p">(</span><span class="s">&quot;../data/nyc-311-sample/nyc-311-2004-sample.csv&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The cleaned dataset has four new variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">opened</span></code>: The date the request was filed in date format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closed</span></code>: The date the request was resolved in date format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resptime</span></code>: The number of days it took to resolve the request (<code class="docutils literal notranslate"><span class="pre">closed</span></code> - <code class="docutils literal notranslate"><span class="pre">opened</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">solvedin7</span></code>: A dummy variable equal to 1 if the request was solved within a week and 0 otherwise.</p></li>
</ul>
<p>We can now use this function on all the six files using <code class="docutils literal notranslate"><span class="pre">lapply()</span></code>, saving each cleaned data frame into a list. (Read more about <code class="docutils literal notranslate"><span class="pre">lapply()</span></code> <a class="reference external" href="http://www.r-bloggers.com/using-apply-sapply-lapply-in-r/">here</a>. Of course, you can also use a <a class="reference external" href="../for-loops">for loop</a>.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># First create a vector with the names of the files we want to read</span>
<span class="n">file_names</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;nyc-311-&quot;</span><span class="p">,</span> <span class="m">2004</span><span class="o">:</span><span class="m">2009</span><span class="p">,</span> <span class="s">&quot;-sample.csv&quot;</span><span class="p">)</span>
<span class="n">file_names</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">file_names</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;../data/nyc-311-sample/nyc-311-&quot;</span><span class="p">,</span> <span class="m">2004</span><span class="o">:</span><span class="m">2009</span><span class="p">,</span> <span class="s">&quot;-sample.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Now use the vector of file names and the &#39;clean_dta&#39; function in lapply()</span>
<span class="n">nyc_all</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">clean_dta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The list <code class="docutils literal notranslate"><span class="pre">nyc_all</span></code> now has six elements, consisting of cleaned data for each of the years in 2004-2009. For example, here’s the first and second elements with the 2004 and 2005 data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">head</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span> <span class="c1">#cleaned data for 2004</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span> <span class="c1">#cleaned data for 2005</span>
</pre></div>
</div>
</div>
<p>Here’s the same task using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop instead. (In reality, you’d either use <code class="docutils literal notranslate"><span class="pre">lapply()</span></code> or a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, not both — this is just for illustrative purposes. As you’ll see, <code class="docutils literal notranslate"><span class="pre">lapply()</span></code> is more compact and elegant in this case, but a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is probably more intuitive.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc_all</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">file_names</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">nyc_all</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">clean_dta</span><span class="p">(</span><span class="n">file_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="p">}</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span> <span class="c1">#take a look at the 2004 data</span>
</pre></div>
</div>
</div>
<p>Finally, let’s <a class="reference external" href="../merging-appending">append</a> the data frames stored in the <code class="docutils literal notranslate"><span class="pre">nyc_all</span></code> list into one data frame. This is easy using <code class="docutils literal notranslate"><span class="pre">do.call()</span></code> and <code class="docutils literal notranslate"><span class="pre">rbind()</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># List of data frames --&gt; one data frame</span>
<span class="n">nyc_all</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">nyc_all</span><span class="p">)</span>
<span class="nf">class</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">)</span> <span class="c1">#nyc_all is now a data frame</span>
<span class="nf">dim</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">)</span> <span class="c1">#nyc_all now has 60,000 observations</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">nyc_all</span><span class="o">$</span><span class="n">opened</span><span class="p">)</span> <span class="c1">#opened contains all years in 2004-2009</span>
</pre></div>
</div>
</div>
</section>
<section id="Complex-analyses">
<h2>Complex analyses<a class="headerlink" href="#Complex-analyses" title="Permalink to this headline">¶</a></h2>
<p>Functions can also be used when you have to carry out a bunch of analyses in a flexible way. Let’s use the <code class="docutils literal notranslate"><span class="pre">nyc_all</span></code> dataset that we just created above to test the hypothesis that it takes city workers in NYC a longer time to resolve requests that are filed during the winter (December-February), presumably because of tougher weather conditions.</p>
<p>First let’s add a dummy variable equal to 1 if a request was filed during December-February.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc_all</span> <span class="o">&lt;-</span> <span class="n">nyc_all</span> <span class="o">%&gt;%</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">winter</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="nf">month</span><span class="p">(</span><span class="n">opened</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">12</span><span class="p">),</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>
<span class="nf">head</span><span class="p">(</span><span class="nf">select</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">,</span> <span class="n">opened</span><span class="p">,</span> <span class="n">winter</span><span class="p">))</span> <span class="c1">#&#39;winter&#39; equals 1 if request opened in Dec-Feb</span>
</pre></div>
</div>
</div>
<p>Now let’s write a function that allows us to test our hypothesis in a few different ways. The function has four parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dta</span></code>: the data frame to use in the analyses (probably <code class="docutils literal notranslate"><span class="pre">nyc_all</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: a regression model, specified in a <code class="docutils literal notranslate"><span class="pre">formula()</span></code> call</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method</span></code>: the method by which to carry out the analysis (either “OLS” or “logit”).</p></li>
</ul>
<p>The output of the will be a regression table (either OLS or logit).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc_analysis</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dta</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="p">{</span>

    <span class="nf">if </span><span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;OLS&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dta</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;logit&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">glm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dta</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="n">binomial</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">return</span><span class="p">(</span><span class="nf">summary</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="p">}</span>

<span class="c1"># Run OLS and logit models</span>
<span class="nf">nyc_analysis</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">,</span> <span class="nf">formula</span><span class="p">(</span><span class="n">resptime</span> <span class="o">~</span> <span class="n">winter</span><span class="p">),</span> <span class="s">&quot;OLS&quot;</span><span class="p">)</span>
<span class="nf">nyc_analysis</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">,</span> <span class="nf">formula</span><span class="p">(</span><span class="n">solvedin7</span> <span class="o">~</span> <span class="n">winter</span><span class="p">),</span> <span class="s">&quot;logit&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>It actually appears that, on average, it takes city workers less time — about 5 days less — to respond to service requests during the winter (OLS model), which is corroborated by the logit model, which shows a higher likelihood of requests being resolved within a week during the winter.</p>
<p>Say we settle for the OLS model and want to graph the OLS coefficient for each year in the data (to look at over-time changes). We can then write a function that gets the OLS coefficient on <code class="docutils literal notranslate"><span class="pre">winter</span></code> for a desired year as well as lower and upper 95% confidence bounds on this estimate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">nyc_ols</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dta</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1"># Filter the data to the desired year</span>
    <span class="n">sub</span> <span class="o">&lt;-</span> <span class="n">dta</span> <span class="o">%&gt;%</span> <span class="nf">filter</span><span class="p">(</span><span class="nf">year</span><span class="p">(</span><span class="n">opened</span><span class="p">)</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>

    <span class="c1"># Run OLS model</span>
    <span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sub</span><span class="p">)</span>

    <span class="c1"># Get the coefficient estimate, standard error, and confidence bounds</span>
    <span class="n">coef</span> <span class="o">&lt;-</span> <span class="nf">coef</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span>
    <span class="n">se</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="nf">vcov</span><span class="p">(</span><span class="n">m</span><span class="p">)))[</span><span class="m">2</span><span class="p">]</span>
    <span class="n">lb</span> <span class="o">&lt;-</span> <span class="n">coef</span> <span class="o">-</span> <span class="n">se</span> <span class="o">*</span> <span class="m">1.96</span>
    <span class="n">ub</span> <span class="o">&lt;-</span> <span class="n">coef</span> <span class="o">+</span> <span class="n">se</span> <span class="o">*</span> <span class="m">1.96</span>

    <span class="c1"># Create a data frame with this information (as well as the year)</span>
    <span class="c1"># The data frame will have only one row</span>
    <span class="n">result</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">row.names</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span>

    <span class="nf">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="p">}</span>

<span class="c1"># Test that the function works for 2004</span>
<span class="nf">nyc_ols</span><span class="p">(</span><span class="n">nyc_all</span><span class="p">,</span> <span class="nf">formula</span><span class="p">(</span><span class="n">resptime</span> <span class="o">~</span> <span class="n">winter</span><span class="p">),</span> <span class="m">2004</span><span class="p">)</span>

<span class="c1"># Confirm using regular approach</span>
<span class="c1"># Coefficient and SE should be the same as above</span>
<span class="nf">summary</span><span class="p">(</span><span class="nf">lm</span><span class="p">(</span><span class="n">resptime</span> <span class="o">~</span> <span class="n">winter</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="nf">year</span><span class="p">(</span><span class="n">opened</span><span class="p">)</span> <span class="o">==</span> <span class="m">2004</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Now that we can run this model for a given year, we can iterate over all the years in the dataset, again using <code class="docutils literal notranslate"><span class="pre">lapply()</span></code> (which creates a list of data frames). We then create one data frame from this list and graph the results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="n">resptime</span> <span class="o">~</span> <span class="n">winter</span><span class="p">)</span>
<span class="n">nyc_results</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="m">2004</span><span class="o">:</span><span class="m">2009</span><span class="p">,</span> <span class="n">nyc_ols</span><span class="p">,</span> <span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
<span class="n">nyc_results</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">nyc_results</span><span class="p">)</span> <span class="c1">#list --&gt; data.frame</span>
<span class="n">nyc_results</span>

<span class="c1"># Graph the results</span>
<span class="nf">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">nyc_results</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coef</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_point</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ub</span><span class="p">),</span> <span class="n">width</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_hline</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;response time during winter compared to summer (days)&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Response time during winter compared to summer (in days)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that negative values indicate how many fewer days, on average, it takes city workers to resolve requests during the winter as compared to the summer. If this analysis is correct, it seems like it takes the city less time to respond to service requests during the winter as compared to the summer (between 2 and 9 days less) for all years except 2004.</p>
<p>We can also run the analyses with controls. Most importantly, maybe a different type of complaint is filed during the winter than during other periods of the year. We can adjust for such potential confounding by introducing complaint type as a covariate in the analysis:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="n">resptime</span> <span class="o">~</span> <span class="n">winter</span> <span class="o">+</span> <span class="nf">factor</span><span class="p">(</span><span class="n">Complaint.Type</span><span class="p">))</span>
<span class="n">nyc_results</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="m">2004</span><span class="o">:</span><span class="m">2009</span><span class="p">,</span> <span class="n">nyc_ols</span><span class="p">,</span> <span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">f</span><span class="p">)</span>
<span class="n">nyc_results</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">nyc_results</span><span class="p">)</span> <span class="c1">#list --&gt; data.frame</span>
<span class="n">nyc_results</span>

<span class="c1"># Graph the results</span>
<span class="nf">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">nyc_results</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coef</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_point</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ub</span><span class="p">),</span> <span class="n">width</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_hline</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;response time during winter compared to summer (days)&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Response time, winter v. summer (controlling for complaint type)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now it indeed seems like it takes <em>longer</em> to resolve service requests during the winter (at least between 2004 and 2006).</p>
<p>To summarize, in the applications above, a function was created to allow for easy and flexible completion of a task. Not creating a function for these tasks would work, though it would also result in more verbose code (e.g., copying and pasting, changing only some aspects of the code). Functions minimize potential mistakes that may result from such manual iteration of code. They are also useful for carrying out a range of analyses and graphing the results, as the last application makes clear.</p>
<p>Exercises</p>
<ol class="arabic simple">
<li><p>Write a function called <code class="docutils literal notranslate"><span class="pre">second_largest</span></code> that finds the second largest value in a vector of numeric values. That is, the input should be a numeric vector and the output should be the second largest value in the vector. You can assume that the input vector has at least two values. Test your function on the following two vectors:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">v1</span> <span class="pre">&lt;-</span> <span class="pre">1:10</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v2</span> <span class="pre">&lt;-</span> <span class="pre">c(15,</span> <span class="pre">1000,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">8)</span></code></p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">second_largest</span></code> function so that it accounts for two special cases: (1) when the user inputs a numeric vector with only one value, the function should return the message “Invalid input: at least two values required”; (2) when the user inputs a vector that is <strong>not</strong> numeric, the function should return the message “Invalid input: only numeric vectors accepted”. Test your new function on the following vectors:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">v1</span> <span class="pre">&lt;-</span> <span class="pre">1:10</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v2</span> <span class="pre">&lt;-</span> <span class="pre">2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v3</span> <span class="pre">&lt;-</span> <span class="pre">c(&quot;banana&quot;,</span> <span class="pre">&quot;apple&quot;,</span> <span class="pre">&quot;orange&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v4</span> <span class="pre">&lt;-</span> <span class="pre">as.factor(1:10)</span></code></p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Using the <code class="docutils literal notranslate"><span class="pre">nyc_all</span></code> data frame created above (it should have 60,000 observations and have observations from 2004 to 2009), write a function called <code class="docutils literal notranslate"><span class="pre">no_obs</span></code> that finds the number of observations for a given complaint type in a given year. The function should have three parameters: <code class="docutils literal notranslate"><span class="pre">dta</span></code> (the data frame of interest), <code class="docutils literal notranslate"><span class="pre">type</span></code> (the complaint type category as a string), and <code class="docutils literal notranslate"><span class="pre">year</span></code> (the year the request was opened). The output of the function should be a data frame with one row with the
name of the complaint type, the year, and a value with the number of observations. The function should be indifferent to whether the complaint type is in upper or lower case or capitalized (e.g., “HEATING”, “Heating”, and “heating” should be counted as one complaint type). You can assume the input data frame (<code class="docutils literal notranslate"><span class="pre">dta</span></code>) always has a variable called <code class="docutils literal notranslate"><span class="pre">Complaint.Type</span></code>. Test your function by ensuring that the results for the complaint types “Sewer”, “sewer”, and “heating” for various years look
as follows:</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="n">no_obs</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dta</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">type</span> <span class="o">&lt;-</span> <span class="nf">tolower</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
    <span class="n">dta</span><span class="o">$</span><span class="n">Complaint.Type</span> <span class="o">&lt;-</span> <span class="nf">tolower</span><span class="p">(</span><span class="n">dta</span><span class="o">$</span><span class="n">Complaint.Type</span><span class="p">)</span>

    <span class="n">sub</span> <span class="o">&lt;-</span> <span class="n">dta</span> <span class="o">%&gt;%</span> <span class="nf">filter</span><span class="p">(</span><span class="n">Complaint.Type</span> <span class="o">==</span> <span class="n">type</span><span class="p">,</span> <span class="nf">year</span><span class="p">(</span><span class="n">opened</span><span class="p">)</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>

    <span class="nf">return</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">complaint.type</span> <span class="o">=</span> <span class="n">type</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">sub</span><span class="p">)))</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="indent"><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-r notranslate"><div class="highlight"><pre>
<span></span><span class="nf">no_obs</span><span class="p">(</span><span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;Sewer&quot;</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="m">2004</span><span class="p">)</span>
<span class="nf">no_obs</span><span class="p">(</span><span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;sewer&quot;</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="m">2004</span><span class="p">)</span>
<span class="nf">no_obs</span><span class="p">(</span><span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;heating&quot;</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="m">2004</span><span class="p">)</span>
<span class="nf">no_obs</span><span class="p">(</span><span class="n">dta</span> <span class="o">=</span> <span class="n">nyc_all</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;heating&quot;</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="m">2009</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div></section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">CM4SS</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_types.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="vectors.html">Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset-basics.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="modifying-data.html">Modifying Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="merging-appending.html">Merging and Appending</a></li>
<li class="toctree-l1"><a class="reference internal" href="collapsing-data.html">Collapsing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="wide-and-long.html">Reshaping</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="controlflow.html">Loops and Control Flow</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="wide-and-long.html" title="previous chapter">Wide &amp; Long Data</a></li>
      <li>Next: <a href="controlflow.html" title="next chapter">Loops</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Nick Eubank & Simon Ejdemyr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/writing-functions.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-133477154-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>